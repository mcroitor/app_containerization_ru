# Рекомендации при разработке контейнеров

- [Рекомендации при разработке контейнеров](#рекомендации-при-разработке-контейнеров)
  - [Избыточные привилегии](#избыточные-привилегии)
    - [Запуск приложений от имени пользователя](#запуск-приложений-от-имени-пользователя)
    - [Запрет на изменение исполняемых файлов](#запрет-на-изменение-исполняемых-файлов)
  - [Зависимости](#зависимости)
    - [Использование многоступенчатых сборок](#использование-многоступенчатых-сборок)
    - [Проверенные базовые образы](#проверенные-базовые-образы)
    - [Своевременное обновление образов](#своевременное-обновление-образов)
    - [Открытые порты](#открытые-порты)
  - [Защита данных](#защита-данных)
    - [Чувствительные данные](#чувствительные-данные)
    - [ADD и COPY](#add-и-copy)
    - [Контекст сборки](#контекст-сборки)
    - [Журналы](#журналы)
  - [Разное](#разное)
    - [Порядок слоёв](#порядок-слоёв)
    - [Метаданные](#метаданные)
    - [Проверка образов на уязвимости](#проверка-образов-на-уязвимости)
  - [Выводы](#выводы)
  - [Библиография](#библиография)

Хорошо подготовленный `Dockerfile` исключает необходимость использовать привилегированные контейнеры, открывать порты, в которых нет необходимости, включать лишние пакеты и избегать утечки чувствительных данных. Эти проблемы необходимо решать сразу, чтобы в дальнейшем сократить усилия на поддержку разрабатываемых приложений.

## Избыточные привилегии

### Запуск приложений от имени пользователя

__Запускайте приложения от имени пользователя с минимальными привилегиями.__

Согласно отчету [Sysdig 2021 container security and usage report](https://sysdig.com/blog/sysdig-2021-container-security-usage-report/), 58% всех контейнеров запускаются от имени пользователя `root`. Использование `root` в контейнерах может привести к серьезным уязвимостям безопасности. Поэтому рекомендуется запускать приложения от имени пользователя с минимальными привилегиями, используя директиву `USER` в Dockerfile.

Чтобы настроить непривилегированного пользователя, необходимо выполнить несколько дополнительных шагов:

- убедиться, что пользователь существует в образе (создать его);
- установить необходимые разрешения на файлы и директории, с которыми работает приложение.

Пример Dockerfile:

```Dockerfile
FROM ubuntu:20.04

# Создание пользователя и установка прав
RUN adduser --no-create-home --disabled-login myuser && \
    chown -R myuser:myuser /app-data

# Копирование приложения
COPY app /app

# Установка рабочего пользователя
USER myuser

ENTRYPOINT ["/app"]
```

### Запрет на изменение исполняемых файлов

__Запретите изменение исполняемых файлов.__

В контейнерах Docker файлы, помеченные атрибутом `+x`, могут быть изменены во время выполнения. Это может привести к изменению исполняемых файлов и, как следствие, к уязвимостям безопасности. Чтобы предотвратить изменение исполняемых файлов, рекомендуется использовать директиву `COPY` вместо `ADD` и устанавливать атрибуты файлов после копирования.

Лучшей идеей является назначить root владельцем исполняемых файлов, в этом случае они не будут доступны на запись для других пользователей. В этом случае контейнер будет неизменяемым и безопасным, позволяя избежать ситуации, при которой запущенное приложение изменено случайно или злонамеренно.

Пользователю контейнера достаточно иметь только права на чтение и выполнение файлов.

```Dockerfile
FROM ubuntu:20.04

# Создание пользователя
RUN adduser --no-create-home --disabled-login myuser && \
    chown -R myuser:myuser /app-data

# Копирование приложения
COPY app /app

RUN chmod +x-w /app

# Установка рабочего пользователя
USER myuser

ENTRYPOINT ["/app"]
```

## Зависимости

__Старайтесь минимизировать размер образа.__

Избегайте установки неиспользуемых пакетов или открытия лишних портов - это может увеличить поверхность атаки. Чем больше компонентов вы включите в контейнер, тем более уязвимой будет ваша система и тем сложнее будет ее обслуживать, особенно для компонентов, не находящихся под вашим контролем.

### Использование многоступенчатых сборок

__Используйте многоступенчатые сборки.__

Эффективный способ уменьшить размер образа - использование многоступенчатых сборок. Это позволяет разделить сборку и запуск приложения на несколько этапов, каждый из которых использует свой собственный образ. Например, вы можете использовать один образ для сборки приложения и другой для запуска его.

При таком подходе создается промежуточный контейнер, который содержит все необходимые зависимости для сборки приложения (инструменты, пакеты, временные файлы). В конечном образе остаются только исполняемые файлы и библиотеки, необходимые для работы приложения. Использование многоступенчатой сборки не только уменьшает размер образа, но и улучшает безопасность, так как атакующий не сможет получить доступ к инструментам сборки и временным файлам.

### Проверенные базовые образы

__Внимательно выбирайте базовые образы.__

Ваши контейнеры основанные на непроверенных и неподдерживаемых образах унаследуют все проблемы и уязвимости из этих базовых образов.

Лучшим вариантом является создание образа с нуля (`scratch`), однако это подходит только для статических бинарных файлов.

Хорошим вариантом будет использование `Distroless` образов, которые содержат только минимальный набор библиотек и инструментов, необходимых для запуска приложения. Это позволяет уменьшить размер образа и уменьшить поверхность атаки.

- [Google Distroless Container Tools](https://github.com/GoogleContainerTools/distroless) - построены на базе Debian, содержит сборки для статически компилируемых языков (C / C++, Go, Rust), а также для Java, Python, Node.js.
- [Chainguard Images](https://github.com/chainguard-images) - собирает небольшие и безопасные образы контейнеров, собираемые на базе Alpine Linux. Есть образы для .NET, php, Ruby и других языков.

Рекомендуется также использовать официальные образы, так как они регулярно обновляются и проверяются на безопасность.

### Своевременное обновление образов

__Используйте базовые образы, которые регулярно обновляются, так же обновляйте ваши образы, основанные на них.__

Процесс обнаружение уязвимостей непрерывен, поэтому правильным подходом будет регулярное обновление с учетом последних исправлений безопасности.

При этом нет необходимости стараться всегда использовать последнюю версию, которая может содержать критические уязвимости, но следует придерживаться стратегии версионирования:

- Придерживайтесь стабильных или long-term версий поддержки, которые быстро и часто предоставляют исправления безопасности;
- Будьте готовы отказаться от старых версий и выполнить миграцию до того, как закончится срок поддержки текущей версии вашего базового образа, и она перестанет получать обновления;
- Кроме того, периодически пересобирайте свои собственные образы используя аналогичную стратегию, чтобы получить последние пакеты из базового дистрибутива, Node, Golang, Python и т. д. Большинство менеджеров пакетов или зависимостей, таких как `composer`, `npm` или `go mod`, `pip` или `poetry` предлагают способы указать диапазоны версий для следите за последними обновлениями безопасности.

### Открытые порты

__Открывайте только необходимые порты.__

Каждый открытый порт в вашем контейнере - это открытая дверь в вашу систему. Оставляйте открытыми только порты, которые действительно нужны вашим приложениям и избегайте таких портов как `SSH (22)`.

Обратите внимание, что хотя в `Dockerfile` присутствует команда `EXPOSE`, эта команда носит скорее информативный характер. Открытие портов не позволяет автоматически подключаться к ним при запуске контейнера (если вы не выполняете команду `docker run --publish-all`), так как все равно необходимо указать публикуемые порты при запуске контейнера.

Используйте команду `EXPOSE` в `Dockerfile` только чтобы обозначить и задокументировать необходимые порты, затем используйте указанные порты в процессе запуска контейнеров.

## Защита данных

При работе с контейнерами надо быть осторожным, чтобы избежать случайной утечки данных.

### Чувствительные данные

__Никогда не помещайте чувствительные данные (пароли, ключи, сертификаты) в Dockerfile.__

Созданный образ может быть легко прочитан, данные могут быть извлечены и использованы злоумышленниками.

Кроме того, будьте осторожны при копировании файлов в контейнер. Даже если важный файл был удален из образа в последующих слоях, к нему можно еще получить доступ в предыдущих слоях.

При создании образа следуйте следующим рекомендациям:

- Если приложение поддерживает работу с переменными окружения, используйте их для передачи конфиденциальных данных в контейнер или воспользуйтесь секретами Docker для работы с конфиденциальными данными.
- Используйте конфигурационные файлы и монтируйте их в контейнер при запуске.

Кроме того, ваши образы не должны содержать конфиденциальную информацию или параметры конфигурации, которые относятся к определенному окружению (например, `dev`, `qa`, `prod` и т. д.).

### ADD и COPY

__Предпочитайте `COPY` команду вместо `ADD`.__

Инструкции `ADD` и `COPY` предоставляют аналогичные функции - копируют файлы из контекста сборки в образ. Однако использование `COPY` является предпочтительным, потому что процесс копирования данных является предсказуемым и менее склонным к ошибкам.

Инструкция `ADD` имеет дополнительные возможности, такие как автоматическое распаковывание архивов и загрузка файлов по URL. Эти возможности могут быть опасными, так как они могут привести к утечке данных или уязвимостям безопасности.

В случае копирования пакета по ссылке будет предпочтительнее использовать `RUN` с командой `wget` или `curl` вместо `ADD`, извлечь его и удалить архив, что позволит уменьшить количество слоёв образа.

Многоступенчатые сборки также решают эту проблему и помогают следовать лучшим практикам, позволяя копировать файлы из архива, распакованного на предыдущем этапе.

### Контекст сборки

__Избегайте копирования всего контекста сборки в образ.__

Плохой практикой является копирование всего контекста сборки в образ, так как это может привести к утечке конфиденциальных данных.

Согласно лучшим практикам необходимо создать папку для всех файлов, которые необходимо скопировать в образ, и использовать эту папку в качестве контекста сборки. Это позволит избежать случайного копирования конфиденциальных данных и уменьшить размер контекста сборки.

Кроме того, используйте `.dockerignore` файл, чтобы исключить ненужные файлы и директории из контекста сборки.

### Журналы

__Проверяйте журналы на конфиденциальные данные.__

Журналы могут содержать конфиденциальные данные, такие как пароли, ключи или персональную информацию. Поэтому необходимо быть осторожным при записи журналов в контейнере.

Используйте переменные окружения для настройки уровня журналирования и монтируйте каталоги для записи журналов вне контейнера.

## Разное

### Порядок слоёв

__Размещайте инструкции в Dockerfile в порядке убывания частоты изменений.__

Порядок инструкций в `Dockerfile` влияет на кэширование слоёв образа. При изменении инструкции все последующие инструкции будут пересобраны, что может привести к увеличению времени сборки.

Поэтому рекомендуется размещать инструкции в `Dockerfile` в порядке убывания частоты изменений. Например, инструкции, которые меняются редко (установка зависимостей, копирование файлов), должны быть размещены в начале Dockerfile, а инструкции, которые меняются часто (компиляция кода, установка пакетов), должны быть размещены в конце Dockerfile.

Плохой порядок инструкций:

```Dockerfile
FROM ubuntu:20.04

COPY . /app

RUN apt-get update && apt-get install -y python3

CMD ["python3", "/app/app.py"]
```

Лучше поменять местами инструкции `COPY` и `RUN`:

```Dockerfile
FROM ubuntu:20.04

RUN apt-get update && apt-get install -y python3

COPY . /app

CMD ["python3", "/app/app.py"]
```

### Метаданные

__Включайте метаданные в образ.__

Настоятельно рекомендуется включать метаданные при создании образа. Метаданные помогают идентифицировать образ, содержат информацию о версии, авторе, лицензии и других важных атрибутах.

### Проверка образов на уязвимости

__Регулярно проверяйте образы на уязвимости.__

Необходимо регулярно тестировать образы на ошибки и уязвимости. Существует множество инструментов, которые помогают автоматизировать этот процесс:

- [Docker Scout](https://docs.docker.com/scout/)
- [Trivy](https://trivy.dev)
- [Clair](https://www.redhat.com/en/topics/containers/what-is-clair)

## Выводы

Соблюдение рекомендаций при разработке `Dockerfile` поможет улучшить безопасность и надежность ваших контейнеров. Это позволит избежать многих проблем, связанных с утечкой данных, уязвимостями безопасности и сложностью обслуживания.

Существует множество рекомендаций (например, подписывание образов, использование `HEALTHCHECK`) которые не были нами рассмотрены, поэтому настоятельно рекомендуется с литературой, указанной в библиографии.

## Библиография

1. [Overview of best practices for writing Dockerfiles](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
2. [Docker Security](https://docs.docker.com/engine/security/)
3. [Newcomb Aaron, Sysdig 2021 container security and usage report: Shifting left is not enough, 2021](https://sysdig.com/blog/sysdig-2021-container-security-usage-report/)
4. [Iradier Álvaro, Top 20 Dockerfile best practices, 2021](https://sysdig.com/blog/dockerfile-best-practices/)
5. [antonkh, Distroless контейнеры, habr.com, 2023](https://habr.com/ru/articles/710968/)
