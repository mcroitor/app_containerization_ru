# Синтаксис Dockerfile

- [Синтаксис Dockerfile](#синтаксис-dockerfile)
  - [Docker](#docker)
  - [Dockerfile](#dockerfile)
  - [Инструкции Dockerfile](#инструкции-dockerfile)
    - [FROM](#from)
    - [COPY](#copy)
    - [ADD](#add)
    - [RUN](#run)
    - [CMD](#cmd)
    - [ENTRYPOINT](#entrypoint)
    - [WORKDIR](#workdir)
    - [USER](#user)
  - [Библиография](#библиография)

## Docker

**Docker** - это программное обеспечение для автоматизации развёртывания и управления приложениями в среде виртуализации на уровне операционной системы. Docker позволяет "упаковать" приложение со всем его окружением и зависимостями в контейнер, который может быть перенесён на любую Linux-систему с поддержкой `cgroups` в ядре, а также предоставляет среду по управлению контейнерами.

Для работы с Docker в ОС Unix / Linux необходимо установить [Docker Engine](https://docs.docker.com/engine/install/).

Для работы с Docker в ОС Windows необходимо установить [Docker Desktop](https://www.docker.com/products/docker-desktop).

## Dockerfile

Образы Docker создаются на основе файла `Dockerfile`. В этом файле описывается, какие команды нужно выполнить, чтобы собрать образ. Выполнение каждой команды создаёт промежуточный образ, называемый *слоем*, который используется для создания следующего образа. Создание промежуточных образов позволяет повторно использовать их при сборке других образов, что позволяет существенно сократить время сборки образа.

Пример файла `Dockerfile`:

```dockerfile
# на основе базового образа ubuntu:18.04
FROM ubuntu:18.04

# обновление списка пакетов и самих пакетов
RUN apt-get update && apt-get -y upgrade
# установка пакета nginx
RUN apt-get install -y nginx
# создание файла index.html
RUN echo "Hello, world!" > /var/www/html/index.html

# запуск nginx
CMD ["nginx", "-g", "daemon off;"]
```

После того, как образ собран, его можно запустить и получить контейнер.

## Инструкции Dockerfile

Следующая таблица содержит список команд, которые можно использовать в файле `Dockerfile`.

| Команда | Описание |
| --- | --- |
| `FROM` | Указывает базовый образ, на основе которого будет создан новый образ. |
| `COPY` | Копирует файлы и директории из контекста сборки в файловую систему образа. |
| `ADD` | Копирует файлы и директории из контекста сборки в файловую систему образа. Позволяет также скачивать файлы из интернета и распаковывать архивы. |
| `RUN` | Выполняет команду в контейнере. Результат выполнения команды сохраняется в образе. |
| `CMD` | Задаёт команду, которая будет выполнена при запуске контейнера. |
| `ENTRYPOINT` | Задаёт команду, которая будет выполнена при запуске контейнера. Команда, заданная в `ENTRYPOINT`, не может быть переопределена при запуске контейнера. |
| `WORKDIR` | Задаёт рабочую директорию для команд `RUN`, `CMD`, `ENTRYPOINT`, `COPY` и `ADD`. |
| `USER` | Задаёт пользователя, от имени которого будут выполняться команды `RUN`, `CMD`, `ENTRYPOINT`, `COPY` и `ADD`. |
| `ENV` | Задаёт переменные окружения. |
| `ARG` | Задаёт аргументы, которые можно передать при сборке образа. |
| `EXPOSE` | Открывает порты для взаимодействия с контейнером. |
| `VOLUME` | Создаёт точки монтирования для взаимодействия с контейнером. |
| `SHELL` | Задаёт командную оболочку, которая будет использоваться для выполнения команд `RUN`, `CMD`, `ENTRYPOINT`, `COPY` и `ADD`. |
| `MAINTAINER` | Задаёт имя и адрес электронной почты автора образа. |
| `LABEL` | Задаёт метаданные образа. |
| `ONBUILD` | Задаёт команды, которые будут выполнены при сборке образа, на основе которого будет создан новый образ. |
| `HEALTHCHECK` | Задаёт команду, которая будет выполняться для проверки состояния контейнера. |
| `STOPSIGNAL` | Задаёт сигнал, который будет отправлен контейнеру для остановки. |

Кроме того, в файле `Dockerfile` можно использовать комментарии, которые начинаются с символа `#`.

### FROM

Каждый новый образ создаётся на основе базового образа. Базовый образ указывается в команде `FROM`. Например, следующая команда создаст образ на основе базового образа `ubuntu:18.04`.

```dockerfile
FROM ubuntu:18.04
```

Созданный образ в данном случае будет включать в себя минимальный набор файлов, необходимых для работы операционной системы Ubuntu 18.04.

Базовый образ должен быть указан в первой строке файла `Dockerfile`. Если базовый образ не указан, то будет использован базовый образ `scratch`, который не содержит никаких файлов, что эквивалентно записи `FROM scratch`.

Для базового образа можно указать тег, который соответствует конкретной версии базового образа. **Тегом** называется специальная текстовая метка, указывающая, например, версию образа или его характеристики. Если тег не указан, то будет использован тег `latest`, который указывает всегда на последний собранный образ.

### COPY

Команда `COPY` копирует файлы и директории из контекста сборки в файловую систему образа. **Контекст сборки** - это директория, в которой находится файл `Dockerfile`. Команда `COPY` имеет следующий синтаксис:

```dockerfile
СOPY <src> <dest>
```

где `<src>` - путь к файлу или директории в контексте сборки, `<dest>` - путь к файлу или директории в файловой системе образа.

### ADD

Команда `ADD` копирует файлы и директории из контекста сборки в файловую систему образа. Позволяет также скачивать файлы из интернета и распаковывать архивы. Команда `ADD` имеет следующий синтаксис:

```dockerfile
ADD <src> <dest>
```

где `<src>` - путь к файлу или директории в контексте сборки, `<dest>` - путь к файлу или директории в файловой системе образа. Если `<src>` - URL-адрес, то файл будет скачан из интернета. Если `<src>` - архив, то он будет распакован в файловую систему образа.

Команда `ADD` работает по следующему алгоритму:

- Путь `<src>` работает в директории контекста сборки, то есть он не может содержать `..` и не может быть абсолютным.
- Если `<src>` - URL-адрес, то файл будет скачан из интернета.
- Если `<src>` - локальный архив `tar` в одном из распознаваемых сжатых форматах (gzip, bz2, xz, identity), то он будет распакован в файловую систему образа.
- Если `<src>` - директория, то она будет скопирована целиком в файловую систему образа, включая метаданные (владельца, права доступа, дату изменения).
- Если `<src>` - файл, то он будет скопирован в файловую систему образа. Если `<dest>` - директория, то файл будет скопирован в эту директорию. Если `<dest>` - файл, то файл будет скопирован в этот файл.
- Если путь `<dest>` не существует, то он будет создан.

Команда `ADD` имеет больше возможностей, чем команда `COPY`, но в целях безопасности рекомендуется использовать команду `COPY` вместо команды `ADD`.

### RUN

Команда `RUN` выполняет команду в контейнере. Результат выполнения команды сохраняется в образе. Команда `RUN` имеет следующий синтаксис:

```dockerfile
RUN <command>
```

где `<command>` - команда, которая будет выполнена в контейнере.

Пример обновления списка пакетов и, собственно, самих пакетов в образе Ubuntu:

```dockerfile
FROM ubuntu:18.04

RUN apt-get update && apt-get -y upgrade
```

### CMD

Команда `CMD` задаёт команду, которая будет выполнена при запуске контейнера. Команда `CMD` имеет следующий синтаксис:

```dockerfile
CMD <command>
```

где `<command>` - команда, которая будет выполнена при запуске контейнера, или в виде массива:

```dockerfile
CMD ["<command>", "<arg1>", "<arg2>", ...]
```

Разница между выполнением команды в виде строки и в виде массива заключается в том, что при выполнении команды в виде строки команда будет выполнена внутри оболочки (shell, sh, bash), а при выполнении команды в виде массива команда будет выполнена напрямую, без оболочки.

Пример запуска контейнера с командой `echo`:

```dockerfile
FROM ubuntu:18.04

CMD echo "Hello, world!"
```

или, в виде массива:

```dockerfile
FROM ubuntu:18.04

CMD ["echo", "Hello, world!"]
```

### ENTRYPOINT

Команда `ENTRYPOINT` задаёт команду, которая будет выполнена при запуске контейнера. Команда, заданная в `ENTRYPOINT`, не может быть переопределена при запуске контейнера. Команда `ENTRYPOINT` имеет следующий синтаксис:

```dockerfile
ENTRYPOINT <command>
```

где `<command>` - команда, которая будет выполнена при запуске контейнера, или в виде массива:

```dockerfile
ENTRYPOINT ["<command>", "<arg1>", "<arg2>", ...]
```

Пример запуска контейнера с командой `echo`:

```dockerfile
FROM ubuntu:18.04

ENTRYPOINT echo "Hello, world!"
```

Разница между командами `CMD` и `ENTRYPOINT` заключается в том, что команда, заданная в `CMD`, может быть переопределена при запуске контейнера, а команда, заданная в `ENTRYPOINT`, не может быть переопределена.

### WORKDIR

Команда `WORKDIR` задаёт рабочую директорию для команд `RUN`, `CMD`, `ENTRYPOINT`, `COPY` и `ADD`. Команда `WORKDIR` имеет следующий синтаксис:

```dockerfile
WORKDIR <path>
```

где `<path>` - путь к рабочей директории. Если рабочая директория не существует, то она будет создана.

Пример задания рабочей директории:

```dockerfile
FROM ubuntu:18.04

WORKDIR /var
CMD ["ls", "-l"]
```

### USER

Команда `USER` задаёт пользователя, от имени которого будут выполняться команды `RUN`, `CMD`, `ENTRYPOINT`, `COPY` и `ADD`. Команда `USER` имеет следующий синтаксис:

```dockerfile
USER <user>
```

где `<user>` - имя пользователя. Пользователь должен существовать в образе. По умолчанию, команды выполняются от имени пользователя `root`.

Пример задания пользователя:

```dockerfile
FROM ubuntu:18.04

USER root
RUN apt-get update && apt-get -y upgrade
USER user
```

В целях безопасности, рекомендуется выполнять команды `CMD`, `ENTRYPOINT` от имени пользователя, отличного от `root`.

## Библиография

1. [Dockerfile reference, docker.com](https://docs.docker.com/engine/reference/builder/)
2. [olemskoi, ENTRYPOINT vs CMD: назад к основам, Слёрм, Habr.com, 2017](https://habr.com/ru/companies/slurm/articles/329138/)
3. [Overview of best practices for writing Dockerfiles](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
