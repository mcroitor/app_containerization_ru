# Особенности настройки кластера контейнеров

- [Особенности настройки кластера контейнеров](#особенности-настройки-кластера-контейнеров)
  - [Аргументы при сборке образа](#аргументы-при-сборке-образа)
  - [Переменные окружения](#переменные-окружения)
  - [Ограничение ресурсов](#ограничение-ресурсов)
  - [Доступ к графическому процессору](#доступ-к-графическому-процессору)
  - [Проверка состояния контейнера](#проверка-состояния-контейнера)
  - [Библиография](#библиография)

## Аргументы при сборке образа

Как уже было рассказано при описании Dockerfile, при сборке образа можно передавать аргументы. Это позволяет управлять процессом сборки образа, например, передавать версию приложения или другие параметры. В Docker Compose аргументы можно задавать в файле `docker-compose.yml` с помощью ключа `build.args`:

```yaml
version: '3.9'

services:
  web:
    build:
      context: .
      args:
        - APP_VERSION=1.0.0
```

## Переменные окружения

При запуске сервиса в контейнер можно передать переменные окружения. Это позволяет управлять поведением контейнера, например, передавать параметры подключения к базе данных или другие параметры.

В Docker Compose переменные окружения можно передавать в файле `docker-compose.yml` с помощью ключа `environment`:

```yaml
version: '3.9'

services:
  web:
    image: myapp:latest
    environment:
      - DB_HOST=db
      - DB_PORT=5432
```

Переменные окружения можно также задавать в виде словаря:

```yaml
version: '3.9'

services:
  web:
    image: myapp:latest
    environment:
      DB_HOST: db
      DB_PORT: 5432
```

Не всегда удобно хранить переменные окружения в файле `docker-compose.yml`. Поэтому часто их выносят в отдельный файл. Если переменные окружения объявлены в файле `.env`, то Docker Compose автоматически подставит их в файл `docker-compose.yml`.

Пример файла `.env`:

```env
DB_HOST=db
DB_PORT=5432
```

Теперь в файле `docker-compose.yml` можно использовать переменные окружения:

```yaml
version: '3.9'

services:
  web:
    image: myapp:latest
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
```

Также можно указать файл с переменными окружения в файле `docker-compose.yml` с помощью ключа `env_file`, причем можно перечислить несколько файлов с переменными окружения:

```yaml
version: '3.9'

services:
  web:
    image: myapp:latest
    env_file:
      - .env
      - runtime.env
```

Следует помнить, что переменные окружения, переданные в файле `docker-compose.yml`, переопределяют переменные окружения, переданные в файле `.env`.

Кроме того, не рекомендуется хранить в файле `.env` пароли и другие секретные данные. Для хранения секретных данных рекомендуется использовать Docker Secrets или другие инструменты для управления секретами.

## Ограничение ресурсов

По умолчанию контейнеры в Docker Compose имеют доступ ко всем ресурсам хоста. Такой неограниченный доступ к ресурсам может привести к недостатку ресурсов для других контейнеров и, соответственно, к конкуренции за ресурсы. Установка явных ограничений на ресурсы позволяет избежать этих проблем.

Для контейнера можно ограничить доступ к памяти и процессору. В Docker Compose это можно сделать с помощью ключа `deploy.resources`:

```yaml
version: '3.9'

services:
  web:
    image: myapp:latest
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 0.5G
```

В данном примере контейнеру `web` доступно не более 0.5 процессора и 1 ГБ памяти. Кроме того, при запуске для контейнера резервируется не менее 0.1 процессора и 0.5 ГБ памяти.

## Доступ к графическому процессору

Для контейнера можно определить доступ к графическому процессору (GPU). В Docker Compose это можно сделать с помощью ключа `deploy.resources`:

```yaml
version: '3.9'

services:
  neural_network:
    image: neuwrl:latest
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              count: 1
              driver: nvidia
```

Данный пример указывает, что для работы контейнера `neural_network` требуется доступ к графическому процессору. Контейнеру резервируется 1 графический процессор. Для работы с графическим процессором используется драйвер `nvidia`.

На данный момент поддерживаются следующие параметры для `capabilities`:

- `gpu` - доступ к графическому процессору;
- `tpu` - доступ к тензорному процессору;

Также могут быть использованы другие параметры для `capabilities`, зависящие от конкретного драйвера графического процессора, например, для использования акселератора CUDA драйвера `nvidia` может быть использован параметр `nvidia-compute`.

## Проверка состояния контейнера

Также можно проверить состояние контейнера после его запуска. Например, можно проверить, что контейнер успешно запустился и готов к работе. В Docker Compose это можно сделать с помощью ключа `healthcheck`:

```yaml
version: '3.9'

services:
  web:
    image: myapp:latest
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
```

После запуска данного кластера контейнеров Docker Compose будет проверять состояние сервиса `web` с помощью команды `curl -f http://localhost` каждые 30 секунд. Если контейнер не ответит на запрос в течение 10 секунд, Docker Compose будет повторять запрос 3 раза. Если контейнер не ответит на запрос после 3 попыток, Docker Compose перезапустит его.

Иногда сервисы в контейнерах пытаются использовать больше ресурсов, чем им доступно. В этом случае может возникать ошибка `OOME` (Out Of Memory Error). Для предотвращения этой ошибки можно использовать правила перезапуска контейнера:

```yaml
version: '3.9'

services:
  web:
    image: myapp:latest
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
```

В данном примере контейнер будет перезапущен в случае ошибки `OOME` не более 3 раз с интервалом 5 секунд. Если контейнер не запустится после 3 попыток, Docker Compose остановит контейнер и выдаст сообщение об ошибке. Условия перезапуска контейнера могут быть следующими:

- `none` - контейнер не будет перезапущен;
- `on-failure` - контейнер будет перезапущен в случае ошибки;
- `any` - контейнер будет перезапущен в любом случае.

## Библиография

1. [Docker Compose file reference](https://docs.docker.com/compose/compose-file/)
