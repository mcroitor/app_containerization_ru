# Управление секретами

- [Управление секретами](#управление-секретами)
  - [Базовые методы защиты](#базовые-методы-защиты)
  - [Использование секретов в Docker](#использование-секретов-в-docker)
  - [Использование секретов в docker-compose](#использование-секретов-в-docker-compose)
  - [Библиография](#библиография)

**Секретами** в ИТ называют информацию, которая необходима для получения доступа, например, пароли или ключи (также могут быть логины или вообще конфиденциальные данные) и требует сокрытия.

Системные администраторы зачастую упускают важные аспекты защиты: например, ограничение привилегий и конфигурацию политик безопасности [Pod Security Standards](https://kubernetes.io/docs/concepts/security/pod-security-standards/) и [Network Policies](https://kubernetes.io/docs/concepts/services-networking/network-policies/).

## Базовые методы защиты

Минимизация привилегий — критически важный аспект безопасности контейнеров. Уязвимости могут возникать, так как Docker по умолчанию запускает контейнеры с базовым набором привилегий, включающим основные разрешения Linux. Всегда следует предпочитать rootless containers, которые запускаются от имени обычного пользователя. Это минимизирует риск того, что злоумышленник получит root-доступ, даже если ему удастся скомпрометировать контейнер. Использование контейнеров не требующих права суперпользователя делает атаки на уровень ядра практически невозможными и усиливает общую безопасность системы.

*Network Policies* играют ключевую роль в безопасности контейнеров, особенно в сложных средах. Изоляция контейнеров через настройки сети помогает предотвратить несанкционированный доступ и утечку данных. Docker поддерживает изоляцию через сети, что позволяет контролировать, какие контейнеры могут взаимодействовать друг с другом.

*Network Policies* предоставляют более детальный уровень управления трафиком между подами. Например, можно настроить политику, которая ограничивает входящий трафик только от определенных подов, создавая тем самым дополнительный уровень защиты.

При создании и развертывании контейнеров защищенность должна закладываться на этапе конфигурации. Использование безопасных практик при написании файлов Dockerfile и Docker Compose поможет избежать распространенных уязвимостей.

Использование секретов в образах и контейнерах Docker возможно несколькими способами:

- переменные окружения - наиболее простой способ передачи секретов в контейнер и наиболее небезопасный. Переменные окружения видны внутри контейнера и могут быть легко прочитаны изнутри контейнера или извне.
- Docker Secrets - специфично для Docker Swarm. Секреты хранятся в зашифрованном виде на узлах кластера и передаются в контейнеры в зашифрованном виде. Секреты доступны только для сервисов, которые их запрашивают.
- использование BuildKit и механизма сборки секретов. Секреты могут быть переданы в контейнер во время сборки образа. Секреты хранятся в зашифрованном виде и не доступны во время выполнения контейнера.
- полноценные хранилища секретов, такие как HashiCorp Vault, AWS Secrets Manager, Azure Key Vault и Google Cloud Secret Manager.

## Использование секретов в Docker

Один из простых способов передачи секретов в контейнер - использование переменных окружения. Для этого необходимо создать образ контейнера с описанием переменной окружения, которая будет содержать секрет. Пример Dockerfile:

```Dockerfile
FROM alpine
ENV SECRET=supersecret
```

Теперь, после сборки образа, переменная окружения SECRET будет доступна внутри контейнера при его запуске:

```bash
docker image build -t myimage .
```

Однако, использование переменных окружения для передачи секретов не является безопасным способом. Переменные окружения видны внутри контейнера. Также плохо их определять в самом Dockerfile, так как они могут быть прочитаны из образа.

Например, если вы выполните команду `docker inspect` на образе, вы увидите переменные окружения:

```bash
docker image inspect myimage
...
            "Env": [
                "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
                "SECRET=supersecret"
            ],
...
```

Также переменные окружения могут быть прочитаны из контейнера:

```bash
docker container run -it -e SECRET=anothersecret --rm myimage sh
echo $SECRET
```

Хранение секретов в переменных окружения является популярным способом, но не самым безопасным. Секреты могут быть прочитаны из образа или контейнера, что делает их уязвимыми для атак.

## Использование секретов в docker-compose


## Библиография

1. [techno_mot, Обзор способов защиты контейнеров Docker: от простого к сложному, habr.com, 2024-11-13](https://habr.com/ru/companies/selectel/articles/854850/)
2. [Kubernetes, Pod Security Standards, kubernetes.io](https://kubernetes.io/docs/concepts/security/pod-security-standards/)
3. [Kubernetes, Network Policies, kubernetes.io](https://kubernetes.io/docs/concepts/services-networking/network-policies/)
