# Виртуализация

- [Виртуализация](#виртуализация)
  - [Виды виртуализации](#виды-виртуализации)
  - [Гипервизоры](#гипервизоры)
  - [Виртуализация на базе QEMU](#виртуализация-на-базе-qemu)
    - [Установка QEMU](#установка-qemu)
    - [Создание виртуальной машины](#создание-виртуальной-машины)
    - [Установка гостевой ОС](#установка-гостевой-ос)
    - [Запуск виртуальной машины](#запуск-виртуальной-машины)
  - [Open Virtualization Format](#open-virtualization-format)
  - [Библиография](#библиография)
  - [Терминология](#терминология)

<div class="epigraph">

_- Совсем как настоящие пчелы, - подумала Алиса._ --- Льюис Кэролл, "Алиса в Стране Чудес"

</div>

__Виртуализация__ — предоставление набора вычислительных ресурсов или их логического объединения, абстрагированное от аппаратной реализации, и обеспечивающее при этом логическую изоляцию друг от друга вычислительных процессов, выполняемых на одном физическом ресурсе.

Примером использования виртуализации является возможность запуска нескольких операционных систем на одном компьютере, при этом каждый из запущенных экземпляров операционной системы работает в изолированной среде, используя свои собственные логические ресурсы.

Программа, выполняющая виртуализацию, называется __гипервизором__. Компьютер, в рамках которого запускается виртуальная машина, называется __хостом__ (en. host), сама виртуальная машина по отношению к _хосту_ является __гостем__ (en. guest).

## Виды виртуализации

В зависимости от уровня абстракции, на котором происходит виртуализация, выделяют следующие виды виртуализации:

- __Аппаратная виртуализация__ - предполагает установку гипервизора без использования хостовой ОС. Аппаратная виртуализация обеспечивает производительность, сравнимую с производительностью физической машины, что дает виртуализации возможность практического использования и влечет её широкое распространение.
- __Программная виртуализация__ - виртуализация на уровне операционной системы. В данном случае виртуализируется только пространство пользователя, а ядро ОС работает напрямую на аппаратном обеспечении.
- __Паравиртуализация__ - виртуализация, предполагающая модификацию гостевой операционной системы для работы с гипервизором. В данном случае гостевая ОС знает о том, что она работает на виртуальной машине и может взаимодействовать с гипервизором напрямую.

## Гипервизоры

Виртуализация выполняется с помощью программных инструментов, называемых __гипервизорами__. Гипервизоры делятся на несколько типов в зависимости от того, где они работают и как они управляют доступом к аппаратному обеспечению:

__Гипервизоры первого типа__, также известные как гипервизоры без операционной системы, – это программы-гипервизоры, установленные непосредственно на аппаратном обеспечении компьютера, а не на операционной системе. Поэтому гипервизоры первого типа обладают более высокой производительностью и обычно используются в корпоративных приложениях.

Примеры гипервизоров первого типа включают _VMware ESXi_, _Citrix XenServer_, _KVM_.

__Гипервизоры второго типа__, также известные как размещенные гипервизоры, устанавливаются в операционной системе. Гипервизоры второго типа подходят для вычислительных возможностей конечных пользователей и обычно используются для тестирования и разработки.

Примерами гипервизоров второго типа являются _VMware Workstation_, _Oracle VirtualBox_, _QEMU_.

__Гибридные гипервизоры__ — термин встречается редко, но иногда используется для описания решений, сочетающих черты гипервизоров первого и второго типа. Пример: _Xen_ может работать как в режиме первого, так и второго типа. _Microsoft Hyper-V_ также часто относят к первому типу, но на клиентских ОС он может работать поверх Windows.

На сегодняшний день существует множество инструментов виртуализации, которые позволяют создавать и управлять виртуальными машинами. Наиболее популярные инструменты виртуализации:

- __VMware ESXi__ - один из самых популярных инструментов виртуализации используемый в корпоративных средах. Предлагается компанией VMware, является гипервизором первого типа.
- __VirtualBox__ - бесплатный инструмент виртуализации, от компании Oracle. VirtualBox является гипервизором второго типа.
- __QEMU__ - эмулятор и виртуализатор, который позволяет запускать виртуальные машины на физическом компьютере. QEMU может работать в режиме полной эмуляции (низкая производительность) или использовать аппаратную виртуализацию через KVM (высокая производительность).
- __KVM__ - модуль ядра Linux, превращающий его в гипервизор первого типа. В связке с QEMU обеспечивает аппаратную виртуализацию.
- __Hyper-V__ - гипервизор первого типа от Microsoft, позволяющий запускать виртуальные машины на базе Windows.

## Виртуализация на базе QEMU

__QEMU__ — это эмулятор и виртуализатор, который позволяет запускать виртуальные машины на физическом компьютере. QEMU поддерживает различные архитектуры процессоров, включая x86, x86-64, ARM, MIPS и многие другие.

QEMU может использоваться различными способами:

- Основной способ — полная эмуляция аппаратного обеспечения (процессор, память, другие устройства) для запуска гостевой операционной системы. В этом случае процессор может эмулироваться полностью или использовать аппаратную виртуализацию через KVM, Xen или Hypervisor.Framework, что позволяет запускать гостевую ОС напрямую на процессоре хоста.
- Также QEMU может запускать отдельные процессы, собранные для одной архитектуры, на другой архитектуре. Например, QEMU может запускать программы, скомпилированные для архитектуры ARM, на компьютере с процессором x86-64.

Гипервизор QEMU представляет собой набор консольных утилит, которые позволяют управлять виртуальными машинами, создавать их, настраивать и удалять. Для удобства управления виртуальными машинами можно использовать графический интерфейс, например, __virt-manager__. Virt-manager позволяет визуально управлять виртуальными машинами, создавать их, настраивать и удалять, а также управлять ресурсами виртуальных машин.

### Установка QEMU

Установка QEMU под Windows является стандартной процедурой, которая заключается в скачивании установочного пакета с официального сайта и последующей установке.

Установка QEMU под Linux также является стандартной процедурой, которая заключается в установке пакета из репозитория дистрибутива. Например, для дистрибутивов на базе Debian (Ubuntu, Mint) установка QEMU выполняется следующей командой:

```bash
sudo apt install qemu
```

В результате, после установки, пользователю будут доступны следующие утилиты:

- `qemu-system-x86_64` - утилита для запуска виртуальных машин на архитектуре x86-64. Для других архитектур используются утилиты для запуска виртуальных машин с похожим названием: `qemu-system-arm`, `qemu-system-mips`, `qemu-system-ppc` и другие.
- `qemu-img` - утилита для создания и управления образами дисков.
- ряд других утилит, например, для трассировки, отладки и т.д.

### Создание виртуальной машины

Для установки гостевой операционной системы необходимо предварительно подготовить образ диска, на который будет установлена операционная система. Образ диска можно создать с помощью утилиты `qemu-img`:

```bash
qemu-img create -f qcow2 disk.qcow2 10G
```

Данная команда создает образ диска `disk.qcow2` размером 10 Гб в формате `qcow2`. Для дополнительной информации о форматах образов дисков, а также о режимах использования `qemu-img` можно воспользоваться командой:

```bash
qemu-img --help
```

### Установка гостевой ОС

После создания образа диска можно установить гостевую операционную систему. Для этого необходимо запустить утилиту `qemu-system-x86_64` с указанием пути к образу диска и образу установочного диска операционной системы. Например, для установки операционной системы Ubuntu:

```bash
# 2 GB RAM, 2 CPU cores
qemu-system-x86_64 -hda disk.qcow2 -cdrom ubuntu.iso -boot d -m 2G -smp 2
```

В данном случае виртуальная машина запускается с образом диска `disk.qcow2` и образом установочного диска операционной системы `ubuntu.iso`. Опция `-boot d` указывает на загрузку с установочного диска. Обратите внимание, что при запуске виртуальной машины с установочного диска необходимо указать количество оперативной памяти (`-m`), также можно дополнительно указать количество ядер процессора (`-smp`), какие-либо другие устройства и их параметры (например, сетевые адаптеры, звуковые карты и т.д.).

### Запуск виртуальной машины

После установки операционной системы можно запустить виртуальную машину без установочного диска:

```bash
# 2 GB RAM, 2 CPU cores, network backend
# port forwarding: host 2222 -> guest 22, host 8080 -> guest 80
qemu-system-x86_64 -hda disk.qcow2 -m 2G -smp 2 -device e1000,netdev=net0 \
    -netdev user,id=net0,hostfwd=tcp::2222-:22,hostfwd=tcp::8080-:80
```

В данном случае виртуальная машина запускается с образом диска `disk.qcow2`, указанным количеством оперативной памяти и ядер процессора, а также сетевым адаптером, подключенным к виртуальной сети.

## Open Virtualization Format

__Open Virtualization Format (OVF)__ - это открытый формат для упаковки и распространения виртуальных машин. Формат OVF является стандартом, он содержит всю информацию, необходимую для развертывания виртуальной машины и не привязан к какой-либо реализации гипервизора или аппаратной архитектуре.

_Пакет OVF_ представляет собой набор следующих файлов:

- описание виртуальной машины в формате XML - ровно один файл с расширением `*.ovf`. Данный файл называется __OVF дескриптором__. В этом файле содержится информация о конфигурации виртуальной машины, включая количество процессоров, объем оперативной памяти, сетевые адаптеры и другие параметры.
- манифест - опциональный файл с расширением `*.mf`.
- сертификат - опциональный файл с расширением `*.cert`.
- диск виртуальной машины - один или несколько файлов с расширением `*.vmdk`, `*.vdi`, `*.qcow2` и т.д. В этих файлах содержится информация о дисках виртуальной машины, включая их размер, формат и другие параметры.
- дополнительные файлы - опциональные файлы, которые могут содержать дополнительные данные, например, ISO-образы, скрипты и т.д.

Виртуальная машина может поставляться как пакет OVF или в виде одного архивного файла с расширением `*.ova`, который является архивом TAR пакета OVF.

## Библиография

1. [Что такое виртуализация?, AWS, aws.amazon.com](https://aws.amazon.com/ru/what-is/virtualization/)
2. [simust, Основы виртуализации (обзор), habr.com, 2022-03-28](https://habr.com/ru/articles/657677/)
3. [Система виртуализации QEMU, calculate-linux.org, 2020-01-24](https://wiki.calculate-linux.org/ru/qemu)
4. [Welcome to QEMU’s documentation!, qemu.org](https://www.qemu.org/docs/master/)
5. [virtual machine manager, virt-manager.org](https://virt-manager.org/)
6. [Open Virtualization Format, Wikipedia](https://en.wikipedia.org/wiki/Open_Virtualization_Format)

## Терминология

- __Гипервизор__ — программное обеспечение (bare-metal или hosted), позволяющее запускать и управлять несколькими виртуальными машинами на одном физическом сервере.
- __Виртуальная машина__ — изолированная программная среда, эмулирующая аппаратное обеспечение компьютера и позволяющая запускать собственную операционную систему и приложения.
- __Гость (guest)__ — виртуальная машина, работающая на гипервизоре.
- __Хост (host)__ — физический сервер, на котором запущен гипервизор.
- __Аппаратная виртуализация__ — виртуализация, при которой гипервизор работает непосредственно на аппаратном обеспечении (гипервизор первого типа).
- __Программная виртуализация__ — виртуализация, при которой гипервизор работает поверх операционной системы (гипервизор второго типа).
- __Паравиртуализация__ — виртуализация, при которой гостевая операционная система модифицирована для работы с гипервизором.
- __Эмуляция__ — копирование поведения аппаратного устройства или программы.
- __OVF__ — (Open Virtualization Format) — открытый формат для упаковки и распространения виртуальных машин; OVA — архивированный вариант OVF.
