# Виртуализация

- [Виртуализация](#виртуализация)
  - [Виды виртуализации](#виды-виртуализации)
  - [Существующие инструменты виртуализации](#существующие-инструменты-виртуализации)
  - [Виртуализация на базе QEMU](#виртуализация-на-базе-qemu)
    - [Установка QEMU](#установка-qemu)
    - [Создание виртуальной машины](#создание-виртуальной-машины)
    - [Установка гостевой ОС](#установка-гостевой-ос)
    - [Запуск виртуальной машины](#запуск-виртуальной-машины)
  - [Библиография](#библиография)
  - [Терминология](#терминология)

<div class="epigraph">

_- Совсем как настоящие пчелы, - подумала Алиса._ --- Льюис Кэролл, "Алиса в Стране Чудес"

</div>

## Виды виртуализации

Программа, выполняющая виртуализацию, называется __гипервизором__. Компьютер, в рамках которого запускается виртуальная машина, называется __хостом__ (en. host), сама виртуальная машина по отношению к _хосту_ является __гостем__ (en. guest).

__Гипервизоры первого__ типа, также известные как гипервизоры без операционной системы, – это программы-гипервизоры, установленные непосредственно на аппаратном обеспечении компьютера, а не на операционной системе. Поэтому гипервизоры первого типа обладают более высокой производительностью и обычно используются в корпоративных приложениях. KVM использует гипервизор первого типа для хостинга нескольких виртуальных машин в операционной системе Linux.

__Гипервизоры второго типа__, также известные как размещенные гипервизоры, устанавливаются в операционной системе. Гипервизоры второго типа подходят для вычислительных возможностей конечных пользователей.

В зависимости от уровня абстракции, на котором происходит виртуализация, выделяют следующие виды виртуализации:

- __Аппаратная виртуализация__ - предполагает установку гипервизора без использования хостовой ОС. Аппаратная виртуализация обеспечивает производительность, сравнимую с производительностью физической машины, что дает виртуализации возможность практического использования и влечет её широкое распространение. Примеры: KVM, Xen, Hyper-V.
- __Программная виртуализация__ - виртуализация на уровне операционной системы. В данном случае виртуализируется только пространство пользователя, а ядро ОС работает напрямую на аппаратном обеспечении. Примеры: Docker, LXC.

## Существующие инструменты виртуализации

На сегодняшний день существует множество инструментов виртуализации, которые позволяют создавать и управлять виртуальными машинами. Наиболее популярные инструменты виртуализации:

- __VMware__ - один из самых популярных инструментов виртуализации, который позволяет создавать и управлять виртуальными машинами на базе гипервизора ESXi.
- __VirtualBox__ - бесплатный инструмент виртуализации, который позволяет создавать и управлять виртуальными машинами на базе гипервизора VirtualBox.
- __QEMU__ - программный эмулятор, который позволяет запускать виртуальные машины на физическом компьютере, используя различные гипервизоры (например, KVM).
- __KVM__ - гипервизор, который позволяет запускать виртуальные машины на базе ядра Linux.
- __Docker__ - инструмент виртуализации на уровне операционной системы, который позволяет создавать и управлять контейнерами.
- __LXC__ - инструмент виртуализации на уровне операционной системы, который позволяет создавать и управлять контейнерами.
- __Hyper-V__ - гипервизор, который позволяет запускать виртуальные машины на базе Windows.

## Виртуализация на базе QEMU

__QEMU__ - это программный эмулятор, который позволяет запускать виртуальные машины на физическом компьютере. QEMU поддерживает различные архитектуры процессоров, включая x86, x86-64, ARM, MIPS и многие другие.

QEMU может использоваться различными способами:

- основным способом является полная эмуляция аппаратного обеспечения (процессор, память, другие устройства) для запуска гостевой операционной системы. В этом случае процессор может эмулироваться полностью или же пользоваться эмуляцией части инструкций (например, при использовании технологии _KVM_, _XEN_ или _Hypervisor.Framework_), что позволяет запускать гостевую операционную систему напрямую на процессоре хоста.
- также QEMU может запускать отдельные процессы, собранные для одной архитектуры, на другой архитектуре. Например, QEMU может запускать программы, скомпилированные для архитектуры ARM, на компьютере с процессором x86-64.

Гипервизор QEMU представляет собой набор консольных утилит, которые позволяют управлять виртуальными машинами, создавать их, настраивать и удалять. Для удобства управления виртуальными машинами можно использовать графический интерфейс, например, __virt-manager__. Virt-manager позволяет вмзуально управлять виртуальными машинами, создавать их, настраивать и удалять, а также управлять ресурсами виртуальных машин.

### Установка QEMU

Установка QEMU под Windows является стандартной процедурой, которая заключается в скачивании установочного пакета с официального сайта и последующей установке.

Установка QEMU под Linux также является стандартной процедурой, которая заключается в установке пакета из репозитория дистрибутива. Например, для дистрибутивов на базе Debian (Ubuntu, Mint) установка QEMU выполняется следующей командой:

```bash
sudo apt install qemu
```

В результате, после установки, пользователю будут доступны следующие утилиты:

- `qemu-system-x86_64` - утилита для запуска виртуальных машин на архитектуре x86-64. Для других архитектур используются утилиты для запуска виртуальных машин с похожим названием: `qemu-system-arm`, `qemu-system-mips`, `qemu-system-ppc` и другие.
- `qemu-img` - утилита для создания и управления образами дисков.
- ряд других утилит, например, для трассировки, отладки и т.д.

### Создание виртуальной машины

Для установки гостевой операционной системы необходимо предварительно подготовить образ диска, на который будет установлена операционная система. Образ диска можно создать с помощью утилиты `qemu-img`:

```bash
qemu-img create -f qcow2 disk.qcow2 10G
```

Данная команда создает образ диска `disk.qcow2` размером 10 Гб в формате `qcow2`. Для дополнительной информации о форматах образов дисков, а также о режимах использования `qemu-img` можно воспользоваться командой:

```bash
qemu-img --help
```

### Установка гостевой ОС

После создания образа диска можно установить гостевую операционную систему. Для этого необходимо запустить утилиту `qemu-system-x86_64` с указанием пути к образу диска и образу установочного диска операционной системы. Например, для установки операционной системы Ubuntu:

```bash
# 2 GB RAM, 2 CPU cores
qemu-system-x86_64 -hda disk.qcow2 -cdrom ubuntu.iso -boot d -m 2G -smp 2
```

В данном случае виртуальная машина запускается с образом диска `disk.qcow2` и образом установочного диска операционной системы `ubuntu.iso`. Опция `-boot d` указывает на загрузку с установочного диска. Обратите внимание, что при запуске виртуальной машины с установочного диска необходимо указать количество оперативной памяти (`-m`), также можно дополнительно указать количество ядер процессора (`-smp`), какие-либо другие устройства и их параметры (например, сетевые адаптеры, звуковые карты и т.д.).

### Запуск виртуальной машины

После установки операционной системы можно запустить виртуальную машину без установочного диска:

```bash
# 2 GB RAM, 2 CPU cores, network backend
# port forwarding: host 2222 -> guest 22, host 8080 -> guest 80
qemu-system-x86_64 -hda disk.qcow2 -m 2G -smp 2 -device e1000,netdev=net0 \
    -netdev user,id=net0,hostfwd=tcp::2222-:22,hostfwd=tcp::8080-:80
```

В данном случае виртуальная машина запускается с образом диска `disk.qcow2`, указанным количеством оперативной памяти и ядер процессора, а также сетевым адаптером, подключенным к виртуальной сети.

## Библиография

1. [Что такое виртуализация?, AWS, aws.amazon.com](https://aws.amazon.com/ru/what-is/virtualization/)
2. [simust, Основы виртуализации (обзор), habr.com, 2022-03-28](https://habr.com/ru/articles/657677/)
3. [Система виртуализации QEMU, calculate-linux.org, 2020-01-24](https://wiki.calculate-linux.org/ru/qemu)
4. [Welcome to QEMU’s documentation!, qemu.org](https://www.qemu.org/docs/master/)
5. [virtual machine manager, virt-manager.org](https://virt-manager.org/)

## Терминология

- __Гипервизор__ - программное обеспечение, позволяющее запускать несколько виртуальных машин на одном физическом сервере.
- __Виртуальная машина__ - программная эмуляция компьютера, работающая на физическом компьютере. Виртуальная машина обладает своей собственной операционной системой и приложениями и управляется эмулятором (гипервизором).
- __Гость__ - виртуальная машина, работающая на гипервизоре.
- __Хост__ - физический сервер, на котором запущен гипервизор.
- __Аппаратная виртуализация__ - виртуализация, при которой гипервизор работает на уровне аппаратного обеспечения.
- __Программная виртуализация__ - виртуализация, при которой гипервизор работает на уровне операционной системы.
- __Эмуляция__ - копирование поведения аппаратного устройства или программы.
